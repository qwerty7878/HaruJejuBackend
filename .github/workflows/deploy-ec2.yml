name: Deploy to AWS EC2

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:  # 수동 실행 가능

env:
  DOCKER_IMAGE_NAME: harujeju-backend
  DOCKER_HUB_REPO: ${{ secrets.DOCKERHUB_USERNAME }}/harujeju

jobs:
  build-and-push:
    name: Build Docker Image
    runs-on: ubuntu-latest
    
    steps:
      # 1. 코드 체크아웃
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      # 2. JDK 21 설정
      - name: ☕ Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # 3. Gradle 캐싱
      - name: 📦 Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 4. Gradle 빌드
      - name: 🔨 Build with Gradle
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test --no-daemon
          echo "✅ Build completed successfully"

      # 5. 빌드 결과 확인
      - name: 📊 Check build artifact
        run: |
          ls -lh build/libs/
          JAR_FILE=$(ls build/libs/*.jar | head -n 1)
          echo "JAR_FILE=${JAR_FILE}" >> $GITHUB_ENV
          echo "Built JAR: ${JAR_FILE}"

      # 6. Docker Buildx 설정 (멀티 플랫폼 빌드)
      - name: 🐳 Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 7. Docker Hub 로그인
      - name: 🔐 Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 8. Docker 메타데이터 생성
      - name: 📝 Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_HUB_REPO }}
          tags: |
            type=sha,prefix={{branch}}-
            type=raw,value=latest

      # 9. Docker 이미지 빌드 & 푸시
      - name: 🚀 Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_HUB_REPO }}:latest
            ${{ env.DOCKER_HUB_REPO }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.DOCKER_HUB_REPO }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_HUB_REPO }}:buildcache,mode=max
          labels: ${{ steps.meta.outputs.labels }}

      # 10. 빌드 결과 출력
      - name: 📋 Output build info
        run: |
          echo "### 🐳 Docker Build Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ env.DOCKER_HUB_REPO }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo "- latest" >> $GITHUB_STEP_SUMMARY
          echo "- ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull Command:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.DOCKER_HUB_REPO }}:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  deploy-to-ec2:
    name: Deploy to EC2
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      # 1. 코드 체크아웃 (배포 스크립트 필요)
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      # 2. SSH 키 설정
      - name: 🔑 Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      # 3. 환경변수 파일 생성
      - name: 📝 Create .env file
        run: |
          cat > .env.prod << EOF
          # Database
          SPRING_DATASOURCE_URL=${{ secrets.DB_URL }}
          SPRING_DATASOURCE_USERNAME=${{ secrets.DB_USERNAME }}
          SPRING_DATASOURCE_PASSWORD=${{ secrets.DB_PASSWORD }}
          
          # Redis
          SPRING_REDIS_HOST=redis
          SPRING_REDIS_PORT=6379
          SPRING_REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          
          # JWT
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          
          # AWS S3
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_S3_BUCKET_NAME=${{ secrets.AWS_S3_BUCKET_NAME }}
          AWS_REGION=ap-northeast-2
          
          # Kakao OAuth
          KAKAO_ID=${{ secrets.KAKAO_ID }}
          KAKAO_SECRET=${{ secrets.KAKAO_SECRET }}
          KAKAO_REDIRECT_URL=${{ secrets.KAKAO_REDIRECT_URL }}
          
          # Mail
          SPRING_MAIL_PASSWORD=${{ secrets.SPRING_MAIL_PASSWORD }}
          
          # Docker
          DOCKER_IMAGE=${{ env.DOCKER_HUB_REPO }}:latest
          EOF

      # 4. 파일 전송
      - name: 📤 Transfer files to EC2
        run: |
          scp -i ~/.ssh/id_rsa .env.prod ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USER }}/harujeju/.env
          scp -i ~/.ssh/id_rsa docker-compose.prod.yml ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USER }}/harujeju/docker-compose.yml
          scp -i ~/.ssh/id_rsa scripts/deploy-ec2.sh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USER }}/harujeju/deploy.sh

      # 5. EC2에서 배포 실행
      - name: 🚀 Deploy on EC2
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            
            cd /home/${{ secrets.EC2_USER }}/harujeju
            
            echo "================================"
            echo "🚀 Starting deployment..."
            echo "================================"
            
            # 실행 권한 부여
            chmod +x deploy.sh
            
            # 배포 스크립트 실행
            ./deploy.sh
            
            echo "================================"
            echo "✅ Deployment completed!"
            echo "================================"
          EOF

      # 6. 헬스체크
      - name: 🏥 Health check
        run: |
          echo "Waiting for application to start..."
          sleep 30
          
          for i in {1..10}; do
            if curl -f http://${{ secrets.EC2_HOST }}:8080/actuator/health > /dev/null 2>&1; then
              echo "✅ Application is healthy!"
              exit 0
            fi
            echo "Attempt $i/10: Waiting..."
            sleep 10
          done
          
          echo "❌ Health check failed!"
          exit 1

      # 7. 배포 결과 알림 (선택사항)
      - name: 📢 Deployment notification
        if: success()
        run: |
          echo "### ✅ Deployment Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Server:** ${{ secrets.EC2_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Access URL:**" >> $GITHUB_STEP_SUMMARY
          echo "- API: http://${{ secrets.EC2_HOST }}:8080" >> $GITHUB_STEP_SUMMARY
          echo "- Health: http://${{ secrets.EC2_HOST }}:8080/actuator/health" >> $GITHUB_STEP_SUMMARY

  # 배포 실패 시 롤백 (선택사항)
  rollback:
    name: Rollback on failure
    needs: deploy-to-ec2
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
      - name: 🔙 Rollback deployment
        run: |
          echo "### ❌ Deployment Failed - Initiating Rollback" >> $GITHUB_STEP_SUMMARY
          # 실제 롤백 로직은 EC2 배포 스크립트에서 처리
