name: Deploy to AWS EC2

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  DOCKER_IMAGE_NAME: harujeju-backend
  DOCKER_HUB_REPO: ${{ secrets.DOCKERHUB_USERNAME }}/harujeju

jobs:
  build-and-push:
    name: Build Docker Image
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: ðŸ“¦ Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ðŸ”¨ Build with Gradle
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test --no-daemon
          echo "âœ… Build completed successfully"

      - name: ðŸ“Š Check build artifact
        run: |
          ls -lh build/libs/
          JAR_FILE=$(ls build/libs/*.jar | head -n 1)
          echo "JAR_FILE=${JAR_FILE}" >> $GITHUB_ENV
          echo "Built JAR: ${JAR_FILE}"

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ðŸš€ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_HUB_REPO }}:latest
            ${{ env.DOCKER_HUB_REPO }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.DOCKER_HUB_REPO }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_HUB_REPO }}:buildcache,mode=max

      - name: ðŸ“‹ Output build info
        run: |
          echo "### ðŸ³ Docker Build Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ env.DOCKER_HUB_REPO }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:** latest, ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  deploy-to-ec2:
    name: Deploy to EC2
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”‘ Configure SSH
        run: |
          mkdir -p ~/.ssh
          cat > ~/.ssh/id_rsa << 'EOF_KEY'
          ${{ secrets.EC2_SSH_KEY }}
          EOF_KEY
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
          
          # SSH ì—°ê²° ìœ ì§€ ì„¤ì •
          cat >> ~/.ssh/config << 'EOF_CONFIG'
          Host *
            ServerAliveInterval 60
            ServerAliveCountMax 10
            TCPKeepAlive yes
          EOF_CONFIG
          chmod 600 ~/.ssh/config
          echo "âœ… SSH key configured"

      - name: ðŸ§ª Test SSH connection
        run: |
          ssh -o ConnectTimeout=10 -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo 'âœ… SSH connection successful'"

      - name: ðŸ“ Create .env file
        run: |
          cat > .env.prod << EOF
          # Docker Image
          DOCKER_IMAGE=${{ env.DOCKER_HUB_REPO }}:latest
          
          # Database
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          
          # JWT
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          
          # AWS S3
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_S3_BUCKET_NAME=${{ secrets.AWS_S3_BUCKET_NAME }}
          AWS_REGION=ap-northeast-2
          
          # Kakao OAuth
          KAKAO_ID=${{ secrets.KAKAO_ID }}
          KAKAO_SECRET=${{ secrets.KAKAO_SECRET }}
          KAKAO_REDIRECT_URL=${{ secrets.KAKAO_REDIRECT_URL }}
          
          # Mail
          SPRING_MAIL_PASSWORD=${{ secrets.SPRING_MAIL_PASSWORD }}
          EOF

      - name: ðŸ“ Create directories on EC2
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            mkdir -p ~/harujeju/logs/{app,mysql,redis}
            mkdir -p ~/harujeju/volumes/{mysql,redis}
            echo "âœ… Directories created"
          EOF

      - name: ðŸ“¤ Transfer files to EC2
        run: |
          scp -i ~/.ssh/id_rsa .env.prod ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USER }}/harujeju/.env
          scp -i ~/.ssh/id_rsa docker-compose.prod.yml ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USER }}/harujeju/docker-compose.yml

      - name: ðŸš€ Deploy on EC2
        timeout-minutes: 10
        run: |
          ssh -o ServerAliveInterval=60 \
              -o ServerAliveCountMax=10 \
              -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            
            cd ~/harujeju
            
            echo "================================"
            echo "ðŸš€ Starting deployment..."
            echo "================================"
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            echo "Stopping old containers..."
            docker-compose down --remove-orphans || true
            
            # ì˜¤ëž˜ëœ ì´ë¯¸ì§€ ì •ë¦¬
            echo "Cleaning old images..."
            docker image prune -af || true
            
            # ìµœì‹  ì´ë¯¸ì§€ pull
            echo "Pulling latest images..."
            docker-compose pull
            
            # ì»¨í…Œì´ë„ˆ ì‹œìž‘
            echo "Starting containers..."
            docker-compose up -d
            
            # ì»¨í…Œì´ë„ˆ ì‹œìž‘ ëŒ€ê¸° (ìµœëŒ€ 5ë¶„)
            echo "Waiting for containers to be healthy..."
            TIMEOUT=300
            ELAPSED=0
            INTERVAL=10
            
            while [ $ELAPSED -lt $TIMEOUT ]; do
              MYSQL_HEALTH=$(docker inspect --format='{{.State.Health.Status}}' harujeju-mysql 2>/dev/null || echo "starting")
              REDIS_HEALTH=$(docker inspect --format='{{.State.Health.Status}}' harujeju-redis 2>/dev/null || echo "starting")
              
              if [ "$MYSQL_HEALTH" = "healthy" ] && [ "$REDIS_HEALTH" = "healthy" ]; then
                echo "âœ… Database services are healthy!"
                
                if docker ps | grep -q harujeju-app; then
                  echo "âœ… Application is running!"
                  break
                fi
              fi
              
              echo "[$ELAPSED/$TIMEOUT] Waiting... MySQL: $MYSQL_HEALTH, Redis: $REDIS_HEALTH"
              sleep $INTERVAL
              ELAPSED=$((ELAPSED + INTERVAL))
            done
            
            if [ $ELAPSED -ge $TIMEOUT ]; then
              echo "âŒ Deployment timeout!"
              docker-compose ps
              docker-compose logs app --tail=50
              exit 1
            fi
            
            # ìµœì¢… ìƒíƒœ í™•ì¸
            echo "================================"
            echo "âœ… Deployment completed!"
            echo "================================"
            docker-compose ps
          EOF

      - name: ðŸ¥ Health check
        timeout-minutes: 5
        run: |
          echo "Waiting for application to be ready..."
          sleep 20
          
          for i in {1..20}; do
            if curl -f http://${{ secrets.EC2_HOST }}:8080/actuator/health > /dev/null 2>&1; then
              echo "âœ… Application is healthy!"
              exit 0
            fi
            echo "Attempt $i/20: Waiting..."
            sleep 15
          done
          
          echo "âŒ Health check failed!"
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            "cd ~/harujeju && docker-compose logs app --tail=100"
          exit 1

      - name: ðŸ“¢ Deployment notification
        if: success()
        run: |
          echo "### âœ… Deployment Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Server:** ${{ secrets.EC2_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Access URLs:**" >> $GITHUB_STEP_SUMMARY
          echo "- API: http://${{ secrets.EC2_HOST }}:8080" >> $GITHUB_STEP_SUMMARY
          echo "- Health: http://${{ secrets.EC2_HOST }}:8080/actuator/health" >> $GITHUB_STEP_SUMMARY
          echo "- Swagger: http://${{ secrets.EC2_HOST }}:8080/swagger-ui.html" >> $GITHUB_STEP_SUMMARY

  rollback:
    name: Rollback on failure
    needs: deploy-to-ec2
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
      - name: ðŸ”™ Rollback notification
        run: |
          echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
