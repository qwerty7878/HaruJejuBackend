name: Deploy to AWS EC2

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  DOCKER_IMAGE_NAME: harujeju-backend
  DOCKER_HUB_REPO: ${{ secrets.DOCKERHUB_USERNAME }}/harujeju

jobs:
  build-and-push:
    name: Build Docker Image
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      # 2. JDK 21 ì„¤ì •
      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # 3. Gradle ìºì‹±
      - name: ðŸ“¦ Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 4. Gradle ë¹Œë“œ
      - name: ðŸ”¨ Build with Gradle
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test --no-daemon
          echo "âœ… Build completed successfully"

      # 5. ë¹Œë“œ ê²°ê³¼ í™•ì¸
      - name: ðŸ“Š Check build artifact
        run: |
          ls -lh build/libs/
          JAR_FILE=$(ls build/libs/*.jar | head -n 1)
          echo "JAR_FILE=${JAR_FILE}" >> $GITHUB_ENV
          echo "Built JAR: ${JAR_FILE}"

      # 6. Docker Buildx ì„¤ì •
      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 7. Docker Hub ë¡œê·¸ì¸
      - name: ðŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 8. Docker ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
      - name: ðŸš€ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_HUB_REPO }}:latest
            ${{ env.DOCKER_HUB_REPO }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.DOCKER_HUB_REPO }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_HUB_REPO }}:buildcache,mode=max

      # 9. ë¹Œë“œ ê²°ê³¼ ì¶œë ¥
      - name: ðŸ“‹ Output build info
        run: |
          echo "### ðŸ³ Docker Build Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ env.DOCKER_HUB_REPO }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:** latest, ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  deploy-to-ec2:
    name: Deploy to EC2
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      # 2. SSH í‚¤ ì„¤ì •
      - name: ðŸ”‘ Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      # 3. í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±
      - name: ðŸ“ Create .env file
        run: |
          cat > .env.prod << EOF
          # Docker Image
          DOCKER_IMAGE=${{ env.DOCKER_HUB_REPO }}:latest
          
          # Database (MySQL ì»¨í…Œì´ë„ˆ ì´ë¦„ ì‚¬ìš©)
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          
          # JWT
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          
          # AWS S3 (ì„ íƒì‚¬í•­)
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_S3_BUCKET_NAME=${{ secrets.AWS_S3_BUCKET_NAME }}
          AWS_REGION=ap-northeast-2
          
          # Kakao OAuth (ì„ íƒì‚¬í•­)
          KAKAO_ID=${{ secrets.KAKAO_ID }}
          KAKAO_SECRET=${{ secrets.KAKAO_SECRET }}
          KAKAO_REDIRECT_URL=${{ secrets.KAKAO_REDIRECT_URL }}
          
          # Mail (ì„ íƒì‚¬í•­)
          SPRING_MAIL_PASSWORD=${{ secrets.SPRING_MAIL_PASSWORD }}
          EOF

      # ðŸ†• ë””ë ‰í† ë¦¬ ìƒì„± ë‹¨ê³„ ì¶”ê°€
      - name: ðŸ“ Create directories on EC2
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            mkdir -p ~/harujeju/logs/{app,mysql,nginx,redis}
            mkdir -p ~/harujeju/volumes/{mysql,redis}
            mkdir -p ~/harujeju/nginx
            mkdir -p ~/harujeju/init-sql
            echo "âœ… Directories created successfully"
          EOF

      # 4. íŒŒì¼ ì „ì†¡
      - name: ðŸ“¤ Transfer files to EC2
        run: |
          scp -i ~/.ssh/id_rsa .env.prod ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USER }}/harujeju/.env
          scp -i ~/.ssh/id_rsa docker-compose.prod.yml ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USER }}/harujeju/docker-compose.yml
      
      # 5. EC2ì—ì„œ ë°°í¬ ì‹¤í–‰
      - name: ðŸš€ Deploy on EC2
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            
            cd /home/${{ secrets.EC2_USER }}/harujeju
            
            echo "================================"
            echo "ðŸš€ Starting deployment..."
            echo "================================"
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
            docker-compose down || true
            
            # ìµœì‹  ì´ë¯¸ì§€ pull
            docker-compose pull
            
            # ì»¨í…Œì´ë„ˆ ì‹œìž‘
            docker-compose up -d
            
            # ì •ë¦¬
            docker image prune -af
            
            # ìƒíƒœ í™•ì¸
            docker-compose ps
            
            echo "================================"
            echo "âœ… Deployment completed!"
            echo "================================"
          EOF

      # 6. í—¬ìŠ¤ì²´í¬
      - name: ðŸ¥ Health check
        run: |
          echo "Waiting for application to start..."
          sleep 30
          
          for i in {1..10}; do
            if curl -f http://${{ secrets.EC2_HOST }}:8080/actuator/health > /dev/null 2>&1; then
              echo "âœ… Application is healthy!"
              exit 0
            fi
            echo "Attempt $i/10: Waiting..."
            sleep 10
          done
          
          echo "âŒ Health check failed!"
          exit 1

      # 7. ë°°í¬ ê²°ê³¼ ì•Œë¦¼
      - name: ðŸ“¢ Deployment notification
        if: success()
        run: |
          echo "### âœ… Deployment Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Server:** ${{ secrets.EC2_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Access URLs:**" >> $GITHUB_STEP_SUMMARY
          echo "- API: http://${{ secrets.EC2_HOST }}:8080" >> $GITHUB_STEP_SUMMARY
          echo "- Health: http://${{ secrets.EC2_HOST }}:8080/actuator/health" >> $GITHUB_STEP_SUMMARY
          echo "- Swagger: http://${{ secrets.EC2_HOST }}:8080/swagger-ui.html" >> $GITHUB_STEP_SUMMARY

  rollback:
    name: Rollback on failure
    needs: deploy-to-ec2
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
      - name: ðŸ”™ Rollback deployment
        run: |
          echo "### âŒ Deployment Failed - Rollback Initiated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The deployment script automatically rolled back to the previous version." >> $GITHUB_STEP_SUMMARY


